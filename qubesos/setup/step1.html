<!DOCTYPE html>
<html lang="ja-JP">
<head>
	<meta charset="utf-8">
	<title>Qubes OS 非公式セットアップガイド Step1: インストール</title>
</head>

<body>
	<link rel="stylesheet" href="/css/main.css">

	<main>
		<h1>Qubes OS 非公式セットアップガイド Step1: インストール</h1>
		<p id="update_date">更新日: 2023/07/21</p>

		<section>
			<p>さて、<a href="/qubesos/setup/step0.html">Step0</a>でインストールメディアの作成までできたことと思います。Step1では実際にコンピューターにQubes OSをインストールしていきます。ISOファイルの検証はサボらずにしましたよね？やっていない場合はStep0をもう一度やり直してください。</p>
			<p>このガイドではLenovo ThinkPad X270にQubes OSをインストールしていきます。</p>
		</section>

		<section>
			<h2>BIOSの設定を変更する</h2>
			<p>Qubes OSはCPUの仮想化支援機能を使用しています。この機能は最近のコンピューターですと大抵オンになっているのですが、モデルによってはオフのものもあるようなのでBIOSの設定画面からオンになっているか確認しておきましょう。Intel VTやIntel VT-d、AMDですとIOMMUなどの名前になっているようです。ついでにQubes OSは現状セキュアブート非対応なのでセキュアブートもオフにします。その他にもネットワークスタックや使用しないペリフェラルなどもオフにしておきましょう。</p>
			<p>起動モードも確認しておきましょう。Qubes OSはUEFIブートに対応しているので、UEFI対応のコンピューターではレガシーBIOS互換のモードではなくUEFIネイティブの起動ができるように設定することを推奨します。</p>
		</section>

		<section>
			<h2>インストールを開始する</h2>
			<p>ではいよいよインストール開始です。インストールメディアを接続し、コンピューターを起動します。メーカー毎に決まっているブートメニューを表示するキー（LenovoはF12）を押して、インストールメディアから起動するように指定します。成功すれば次のような画面が表示されます。</p>
			<img src="/qubesos/setup/img/grub.jpg">
			<p>Install Qubes OS R4.2.0-rc1を選択します。最新モデルのコンピューターを使用しているなど、この方法でうまく動作しない場合は一番下のInstall Qubes OS R4.2.0-rc1 using kernel-latestを選択してみてください。選択してEnterを押すとインストーラーの起動処理が始まります。起動処理が終わると言語選択画面が表示されます。</p>
			<img src="/qubesos/setup/img/lang.jpg">
			<p>日本語を選択して右下の続行ボタンを押します。すると設定項目の一覧画面が表示されます。まず、最初にタイムゾーンを選択します。日付と時刻をクリックして、</p>
			<img src="/qubesos/setup/img/timezone.jpg">
			<p>世界地図の日本をクリックします。すると地域：アジア、都市：東京がセットされるので、完了ボタンを押します。</p>
			<p>次はインストール先をクリックします。インストール先デバイスの選択画面が表示されるので、</p>
			<img src="/qubesos/setup/img/disk1.jpg">
			<p>ストレージの設定→カスタムを選択し、完了をクリックします。するとパーティションの選択画面が表示されます。標準ではLVMシンプロビジョニングが使用されるのですが、せっかくなのでBTRFSでセットアップします。BTRFSの構成もサポートされているので安心してください。</p>
			<img src="/qubesos/setup/img/disk2.jpg">
			<p>BTRFSを選択し、データを暗号化するにチェックを入れます。（暗号化は当然ですよね？）次は、既存の不要なパーティションを全て削除します。不明というところをクリックしてパーティションのリストを表示し、左下のマイナスボタンでパーティションを削除していきます。</p>
			<img src="/qubesos/setup/img/disk3.jpg">
			<p>すべてのパーティションを削除すれば、左下の使用できる領域とすべての領域の値が一致するはずです。</p>
			<img src="/qubesos/setup/img/disk4.jpg">
			<p>さて、不要なパーティションの削除が終わったのでQubes用のパーティションを作成しましょう。「ここをクリックすると自動的に作成します」をクリックして、パーティションを作成してください。作成ができると次のような画面になります。</p>
			<img src="/qubesos/setup/img/disk5.jpg">
			<p>左上の完了を押すとディスク暗号化のパスワード入力画面が表示されます。十分な長さで推測されない強力なパスワードを入力しましょう。著者のメインPCはパスワード120桁です。</p>
			<img src="/qubesos/setup/img/disk6.jpg">
			<p>最後に最終確認画面が出るのでOKして次はユーザー作成を行います。ユーザーの作成をクリックして、</p>
			<img src="/qubesos/setup/img/user.jpg">
			<p>ユーザー名とパスワードを入力してください。紛らわしいのですが、このパスワードはロック画面を解除する際に使用するパスワードで、ディスク暗号化のパスワードとは別の物です。こちらは程々の強度のもので構いません。フルネームは空欄、ユーザー名はOPSECの観点から「user」などが好ましいと思います。</p>
			<p>さて、設定の第一段階が終わりました。rootアカウントは無効のままで構いませんし、その他にも触れてない設定項目はデフォルトのままで問題ないでしょう。設定が終わると次のような状態になっているはずです。</p>
			<img src="/qubesos/setup/img/config.jpg">
			<p>設定が終わったことを確認したら、インストールの開始をクリックしましょう。インストールにはしばらくかかるので、休憩を取るのもよいでしょう。インストールが終わると再起動ボタンが押せるようになるので押して再起動します。インストール用メディアは不要なので取り外して構いません。</p>
			<p>再起動後はディスク暗号化のパスワード入力画面が現れるので、パスワードを入力してください。入力して少し待つと、第二段階の設定画面が表示されます。</p>
			<img src="/qubesos/setup/img/final.jpg">
			<p>中央のQubes OSというところをクリックしてください。次のような画面になるはずです。</p>
			<img src="/qubesos/setup/img/final2.jpg">
			<p>何だか難しそうな設定画面が登場しました。ここでは推奨する設定も含め簡単に解説します。</p>
			<ul>
				<li><b>Installation:</b>: どのディストリビューションをインストールするか設定します。Qubes OSの標準ディストリビューションはFedoraなので、Fedoraはチェックすることを推奨します。Debianはお好みで、WhonixはTorを使う場合はオンにしましょう。DebianやWhonixはあとからインストールすることもできます。</li>
				<li><b>Default:</b>: システムの標準ディストリビューションを設定します。トラブルを減らすためにもQubes標準のFedoraを設定することを推奨します。</li>
				<li><b>Create default system qubes (sys-net, sys-firewall, default DispVM)</b>: ネットワーク接続の機能に必要なqubeなど、必須といえるqubeを作成します。特別な理由がない限りオンにしてください。</li>
				<li><b>Make sys-firewall and sys-usb disposable</b>: ファイアウォールとUSBを扱うqubeが再起動毎にリセットされるようにします。リセットする方が高セキュリティです。通常の使用ではリセットにデメリットはないのでオンにすることを推奨します。</li>
				<li><b>Make sys-net disposable</b>: ネットワークを扱うqubeが再起動毎にリセットされるようにします。一つ上の設定（sys-fireallとsys-usb）と違って、状況によってはオフの方がいい場合があります。それはWi-Fi経由でインターネットに接続する場合です。この設定をオンにすると、再起動毎にWi-Fiのパスワードを入れる必要が発生します。なので、普段有線でネット接続する場合はオンに、普段無線でネット接続する場合はオフにすることを推奨します。オンの方が高セキュリティです。</li>
				<li><b>Create default application qubes</b>: プリセットとして用意されたqubeを展開するか選べます。インストール後にすぐ使い始めたい場合はオンにするとよいでしょう。これはセキュリティとは特に関係ありません。</li>
				<li><b>Use a qube to hold all USB controllers</b>: USBをセキュアに扱う専用のqube（USB qube）を作成するか選べます。これをオンにするとUSB関連のセキュリティが大幅に向上するのでオンがお勧めなのですが、この機能を使用できない状況も存在するので注意が必要です。あなたのコンピューターがデスクトップ機で、キーボードがUSB接続の場合にはこれをオンにできない可能性があります。詳しくはフォーラム等で質問してください。<a href="https://www.qubes-os.org/doc/usb-qubes/">公式の文書</a>も確認してください。それ以外の場合はオンが推奨されます。</li>
				<li><b>Use sys-net qube for both networking and USB devices</b>: これをオンにするとsys-netというネットワーク用のqubeがUSBの処理も担うようになります。この設定はUSB-イーサネットアダプタやUSB-Wi-Fi子機などを使用するユーザーのためのものです。インターネット接続にそれらの機器が必要な場合はオンに、それ以外の場合にはオフにしてください。オフにすると多少セキュリティが向上します。</li>
				<li><b>Automatically accept USB mice</b>: USB qubeを設定したシステムで、USB接続のマウスを使用すると通常は接続する毎に確認が求められるのですが、これをオンにするとその確認をスキップできるようになります。ただし、BadUSB攻撃によってシステムを勝手に操作させられる可能性が多少出てきますので、オンにする場合は個人の判断で行ってください。USB接続のマウスを使用していない（ラップトップのタッチパッドを使用する等）場合はオフのままにしてください。</li>
				<li><b>Automatically accept USB keyboard</b>: 上記のUSBキーボード版です。一つ違うのが、こちらはBadUSBを食らった際のリスクがかなり高くなるという点です。ラップトップのキーボード等を使う場合は必ずオフに、そうでない場合も多少面倒でもオフにすることを推奨します。</li>
				<li><b>Create Whonix Gateway and Workstation qubes</b>: Whonixが使用するqubeを作成します。WhonixやTorを使いたい場合はオンに、そうでない場合はオフにしましょう。</li>
				<li><b>Enable system and template updates over the Tor anonymity network using Whonix</b>: システムやディストリビューションの更新のダウンロードをTor経由で行うか選択できます。Torを使わないといけないような監視下のネットワークにある人はオンにしたほうがよいかも知れませんが、これをオンにすると更新に時間がかかるようになるのでデメリットもあります。日本に住んでいる一般の方はオフでよいと思います。</li>
				<li><b>Do not configure anything</b>: 何も設定しないという上級者向けの設定です。オンにしないでください。</li>
			</ul>
			<p>設定が終わったら左上から設定を完了しましょう。第二段階のインストール作業が始まります。これにはしばらくかかります。作業が完了するとログイン画面が表示されます。パスワードを入力してログインしてください。これでインストールは完了です。お疲れさまでした。</p>
			<p>作業を終える前に必ず<a href="/qubesos/setup/step2.html">Step2</a>を実行してください。セキュリティを維持するには継続的なシステムのメンテナンスが重要です。</p>
		</section>
	</main>

	<footer>
		<a href="/about/">このWebサイトについて</a>
	</footer>
</body>
</html>
